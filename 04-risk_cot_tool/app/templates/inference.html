{% extends "base.html" %}

{% block header %}思维链 (CoT) 推理{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full" x-data="inferenceApp()">
    
    <!-- Left Column: Config -->
    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
        <h2 class="text-lg font-semibold text-gray-800 mb-6">任务配置</h2>
        
        <div class="space-y-5 flex-1">
            <div x-data="{ isDragging: false }">
                <label class="block text-sm font-medium text-gray-700 mb-1">输入文件 (JSONL)</label>
                
                <!-- Upload Area -->
                <div class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center hover:border-blue-500 hover:bg-blue-50/50 transition-all cursor-pointer group mb-4"
                     :class="{'border-blue-500 bg-blue-50': isDragging}"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="isDragging = false; handleFileDrop($event)"
                     @click="$refs.fileInput.click()">
                     
                    <input type="file" x-ref="fileInput" class="hidden" accept=".jsonl,.json" @change="handleFileSelect">
                    
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform duration-300">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700">点击上传或拖拽文件</p>
                    <p class="mt-1 text-xs text-gray-400">支持 .jsonl, .json 格式</p>
                </div>

                <!-- Manual Input Fallback -->
                <div class="flex space-x-2">
                    <input type="text" x-model="inputFile" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50" placeholder="或手动输入文件名...">
                    <button @click="loadLastFile" class="text-xs text-blue-600 hover:text-blue-800 whitespace-nowrap">加载上次</button>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <input type="password" x-model="apiKey" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                <input type="text" x-model="apiBase" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://api.deepseek.com/chat/completions">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">模型名称</label>
                <input type="text" x-model="modelName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="deepseek-reasoner">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">并发线程数</label>
                <input type="number" x-model="workers" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" min="1" max="20">
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-100">
            <template x-if="status.status !== 'running'">
                <button @click="startInference" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition shadow-lg shadow-blue-200">
                    开始推理任务
                </button>
            </template>
            <template x-if="status.status === 'running'">
                <button @click="stopInference" 
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg transition shadow-lg shadow-red-200">
                    停止任务
                </button>
            </template>
        </div>
    </div>

    <!-- Right Column: Status & Logs -->
    <div class="lg:col-span-2 flex flex-col space-y-6">
        
        <!-- Status Cards -->
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">任务状态</div>
                <div class="text-xl font-bold capitalize flex items-center">
                    <span class="w-2.5 h-2.5 rounded-full mr-2"
                          :class="{
                              'bg-gray-300': status.status === 'idle',
                              'bg-blue-500 animate-pulse': status.status === 'running',
                              'bg-green-500': status.status === 'completed',
                              'bg-red-500': status.status === 'error',
                              'bg-yellow-500': status.status === 'stopped'
                          }"></span>
                    <span x-text="status.status"></span>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">进度</div>
                <div class="text-xl font-bold text-gray-800">
                    <span x-text="status.processed">0</span> / <span x-text="status.total > 0 ? status.total : '-'">-</span>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="text-sm text-gray-500 mb-1">输出文件</div>
                <div class="text-sm font-medium text-gray-800 truncate" title="查看日志获取完整路径">
                    查看日志...
                </div>
            </div>
        </div>

        <!-- Log Console -->
        <div class="flex-1 bg-slate-900 rounded-xl shadow-inner p-4 font-mono text-xs text-green-400 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 pb-2 border-b border-slate-700">
                <span class="text-gray-400">系统日志</span>
                <span class="text-gray-500" x-text="new Date().toLocaleTimeString()"></span>
            </div>
            <div class="flex-1 overflow-y-auto space-y-1" id="log-container">
                <template x-for="(log, idx) in logs" :key="idx">
                    <div x-text="'> ' + log"></div>
                </template>
                <template x-if="logs.length === 0">
                    <div class="text-gray-600 italic">等待任务启动...</div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function inferenceApp() {
        return {
            inputFile: '',
            apiKey: '',
            apiBase: 'https://api.deepseek.com/chat/completions',
            modelName: 'deepseek-reasoner',
            workers: 5,
            
            status: { status: 'idle', processed: 0, total: 0 },
            logs: [],
            eventSource: null,

            init() {
                this.loadLastFile();
                this.connectStream();
            },

            loadLastFile() {
                const last = localStorage.getItem('last_alpaca_file');
                if (last) this.inputFile = last;
            },

            async handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) await this.uploadFile(file);
            },

            async handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file) await this.uploadFile(file);
            },

            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);
                
                this.addLog('正在上传文件...');
                
                try {
                    const res = await fetch('/api/inference/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        this.inputFile = data.filename;
                        this.addLog(`文件上传成功: ${data.filename}`);
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '文件上传成功' } }));
                    } else {
                        throw new Error(data.message);
                    }
                } catch (e) {
                    this.addLog(`上传失败: ${e.message}`);
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: e.message, type: 'error' } }));
                }
            },

            connectStream() {
                if (this.eventSource) this.eventSource.close();
                
                this.eventSource = new EventSource('/api/inference/status');
                this.eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.status = data;
                    
                    if (data.status === 'running') {
                         // Maybe update log less frequently or simulate logs based on progress
                    }
                    
                    if (data.error) {
                        this.addLog(`Error: ${data.error}`);
                    }
                    
                    if (data.status === 'completed' && this.status.status !== 'completed') {
                         this.addLog('任务完成！');
                    }
                };
            },

            addLog(msg) {
                this.logs.push(`${new Date().toLocaleTimeString()} ${msg}`);
                // Auto scroll
                this.$nextTick(() => {
                    const container = document.getElementById('log-container');
                    if (container) container.scrollTop = container.scrollHeight;
                });
            },

            async startInference() {
                if (!this.inputFile || !this.apiKey) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: '请完善配置信息', type: 'error' } }));
                    return;
                }

                this.logs = []; // Clear logs
                this.addLog('正在启动任务...');
                
                try {
                    const res = await fetch('/api/inference/run', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            input_file: this.inputFile,
                            api_key: this.apiKey,
                            base_url: this.apiBase,
                            model: this.modelName,
                            workers: this.workers
                        })
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        this.addLog(`任务已启动。输出文件: ${data.output_file}`);
                        // Save output file for inspector
                        localStorage.setItem('last_inference_output', data.output_file);
                    } else {
                        throw new Error(data.message);
                    }
                } catch (e) {
                    this.addLog(`启动失败: ${e.message}`);
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: e.message, type: 'error' } }));
                }
            },

            async stopInference() {
                try {
                    await fetch('/api/inference/stop', { method: 'POST' });
                    this.addLog('发送停止信号...');
                } catch (e) {
                    this.addLog(`停止失败: ${e.message}`);
                }
            }
        }
    }
</script>
{% endblock %}