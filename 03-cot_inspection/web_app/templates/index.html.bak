<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思维链合成数据质检工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .score-badge {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .progress {
            height: 25px;
        }
        .sample-card {
            cursor: pointer;
        }
        .sample-card:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-brain me-2"></i>
                思维链合成数据质检工具
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 上传区域 -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5><i class="fas fa-upload me-2"></i>数据上传</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <input type="file" class="form-control" id="fileInput" accept=".jsonl">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="inspectionType">
                            <option value="model">模型质检（AI评估）</option>
                            <option value="rule">规则质检（自动检查）</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="startInspection()">
                        <i class="fas fa-play me-2"></i>开始质检
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="downloadResults()">
                        <i class="fas fa-download me-2"></i>下载结果
                    </button>
                </div>
            </div>
        </div>

        <!-- 进度和统计 -->
        <div class="card mb-4" id="progressSection" style="display: none;">
            <div class="card-header bg-light">
                <h5><i class="fas fa-chart-line me-2"></i>质检进度</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>总样本数</h6>
                            <h4 id="totalSamples">0</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>已完成</h6>
                            <h4 id="completedSamples">0</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>平均分</h6>
                            <h4 id="averageScore">0.00</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>合格率</h6>
                            <h4 id="passRate">0%</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 样本列表 -->
        <div class="card" id="resultsSection" style="display: none;">
            <div class="card-header bg-light">
                <h5><i class="fas fa-list me-2"></i>质检结果</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>Instruction</th>
                                <th>Input</th>
                                <th>Output</th>
                                <th>得分</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 样本详情模态框 -->
        <div class="modal fade" id="sampleModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">样本详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Instruction:</label>
                            <textarea class="form-control" id="modalInstruction" rows="2" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Input:</label>
                            <textarea class="form-control" id="modalInput" rows="2" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Output:</label>
                            <textarea class="form-control" id="modalOutput" rows="4" readonly></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">得分:</label>
                                <input type="text" class="form-control" id="modalScore" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">质检类型:</label>
                                <input type="text" class="form-control" id="modalType" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let inspectionResults = [];
        
        function startInspection() {
            const fileInput = document.getElementById('fileInput');
            const inspectionType = document.getElementById('inspectionType').value;
            
            if (!fileInput.files.length) {
                alert('请选择JSONL文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('type', inspectionType);

            // 显示进度区域
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';

            fetch('/inspect', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                inspectionResults = data.results;
                updateProgress(data);
                updateResultsTable(data.results);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('质检过程出错');
            });
        }

        function updateProgress(data) {
            document.getElementById('totalSamples').textContent = data.total;
            document.getElementById('completedSamples').textContent = data.processed;
            document.getElementById('averageScore').textContent = data.average_score.toFixed(2);
            document.getElementById('passRate').textContent = data.pass_rate + '%';
            
            const progressPercent = (data.processed / data.total) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progressPercent + '%';
            progressBar.textContent = progressPercent.toFixed(1) + '%';
        }

        function updateResultsTable(results) {
            const tableBody = document.getElementById('resultsTable');
            tableBody.innerHTML = '';

            results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'sample-card';
                row.onclick = () => showSampleDetails(result);
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${result.instruction.substring(0, 50)}${result.instruction.length > 50 ? '...' : ''}</td>
                    <td>${result.input.substring(0, 30)}${result.input.length > 30 ? '...' : ''}</td>
                    <td>${result.output.substring(0, 50)}${result.output.length > 50 ? '...' : ''}</td>
                    <td>
                        <span class="badge ${getScoreBadgeClass(result.score)}">
                            ${result.score.toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${result.score >= 6.0 ? 'bg-success' : 'bg-danger'}">
                            ${result.score >= 6.0 ? '合格' : '不合格'}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function getScoreBadgeClass(score) {
            if (score >= 8.0) return 'bg-success';
            if (score >= 6.0) return 'bg-warning text-dark';
            return 'bg-danger';
        }

        function showSampleDetails(sample) {
            document.getElementById('modalInstruction').value = sample.instruction;
            document.getElementById('modalInput').value = sample.input;
            document.getElementById('modalOutput').value = sample.output;
            document.getElementById('modalScore').value = sample.score.toFixed(2);
            document.getElementById('modalType').value = sample.inspection_type;
            
            const modal = new bootstrap.Modal(document.getElementById('sampleModal'));
            modal.show();
        }

        function downloadResults() {
            if (inspectionResults.length === 0) {
                alert('没有可下载的结果');
                return;
            }

            const jsonData = JSON.stringify(inspectionResults, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inspection_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 拖拽上传功能
        const fileInput = document.getElementById('fileInput');
        const dropZone = fileInput.parentElement;
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e9ecef';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
            }
        });
    </script>
</body>
</html>